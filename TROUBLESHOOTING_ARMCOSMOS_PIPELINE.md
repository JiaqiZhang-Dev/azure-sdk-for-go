# Troubleshooting armcosmos Pipeline Failures

This guide helps diagnose and fix common pipeline failures for the armcosmos module.

## Quick Checklist

When a pipeline fails, check these items in order:

### 1. Build Phase Failures
```bash
cd sdk/resourcemanager/cosmos/armcosmos
go build ./...
```

**Common Issues:**
- Missing dependencies → Run `go mod tidy`
- Syntax errors → Check the error message for file/line
- Import cycle → Reorganize imports

### 2. Test Phase Failures
```bash
cd sdk/resourcemanager/cosmos/armcosmos
go test -v ./...
```

**Common Issues:**
- Test failures → Check test output
- Test timeout → Increase timeout or optimize tests
- Missing test proxy → Tests will auto-download it
- Recording issues → Verify assets.json and recordings

### 3. Vet Phase Failures
```bash
cd sdk/resourcemanager/cosmos/armcosmos
go vet ./...
```

**Common Issues:**
- Unreachable code
- Printf format mismatches
- Struct tag errors
- Shadow variables

### 4. Analysis Phase Failures

#### Format Check
```bash
cd sdk/resourcemanager/cosmos/armcosmos
gofmt -l .
# Should return nothing. If files are listed, run:
gofmt -w .
```

#### Go Mod Tidy Check
```bash
cd sdk/resourcemanager/cosmos/armcosmos
go mod tidy
git diff go.mod go.sum
# Should show no differences
```

#### Linting (requires golangci-lint installation)
```bash
# Install golangci-lint first
curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0

# Run linter
cd sdk/resourcemanager/cosmos/armcosmos
golangci-lint run -c ../../eng/.golangci.yml
```

**Common Linting Issues:**
- Unused variables
- Inefficient string concatenation
- Error handling issues
- Documentation missing on exported functions

#### Copyright Header Check
All Go files must have a copyright header:
```go
//go:build go1.18
// +build go1.18

// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License. See License.txt in the project root for license information.
// Code generated by Microsoft (R) AutoRest Code Generator. DO NOT EDIT.
// Changes may cause incorrect behavior and will be lost if the code is regenerated.
```

#### CHANGELOG Check
Ensure CHANGELOG.md:
- Has an entry for unreleased changes (if applicable)
- Follows the standard format
- Lists breaking changes in a Breaking Changes section
- Lists new features in a Features Added section

## Common Pipeline Failure Scenarios

### Scenario 1: "golangci-lint failed"
**Diagnosis:**
```bash
cd sdk/resourcemanager/cosmos/armcosmos
golangci-lint run -c ../../eng/.golangci.yml
```

**Fix:** Address each linting error individually. Common fixes:
- Remove unused variables/imports
- Add documentation to exported types/functions
- Fix error handling patterns

### Scenario 2: "go mod tidy failed"
**Diagnosis:**
```bash
cd sdk/resourcemanager/cosmos/armcosmos
go mod tidy
git status
```

**Fix:** If go.mod or go.sum changed:
- Review the changes
- Commit them as part of your PR
- Ensure no unintended dependency changes

### Scenario 3: "Tests failed"
**Diagnosis:**
```bash
cd sdk/resourcemanager/cosmos/armcosmos
go test -v ./...
```

**Fix:**
- Check test output for specific failures
- Ensure test recordings are up to date
- Verify test proxy is working
- Check for test data dependencies

### Scenario 4: "Format Check failed"
**Diagnosis:**
```bash
cd sdk/resourcemanager/cosmos/armcosmos
gofmt -l .
```

**Fix:**
```bash
gofmt -w .
git add .
git commit -m "Fix formatting issues"
```

### Scenario 5: "Verify doc.go failed"
**Diagnosis:** Check if doc.go exists

**Fix:** For non-ARM packages, ensure a doc.go file exists with package documentation:
```go
// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License. See License.txt in the project root for license information.

// Package armcosmos provides operations for working with Azure Cosmos DB.
package armcosmos
```

### Scenario 6: "Copyright header Check failed"
**Diagnosis:** Check files for missing copyright headers

**Fix:** Add the appropriate copyright header to all Go files

### Scenario 7: "Verify Links failed"
**Diagnosis:** Broken links in markdown files

**Fix:**
- Fix broken links in README.md, CHANGELOG.md, etc.
- Update URLs to valid endpoints
- Remove dead links

### Scenario 8: "Component Detection failed"
**Diagnosis:** Dependency issues

**Fix:**
- Review dependency list
- Remove unnecessary dependencies
- Update vulnerable dependencies

## Advanced Diagnostics

### Checking Pipeline Logs
If you have access to the Azure DevOps build:
1. Navigate to the build URL
2. Check each job's logs (Build/Test, Analyze)
3. Look for red X marks indicating failures
4. Expand failed steps to see detailed error messages

### Local Simulation
Run the full pipeline locally:
```bash
# Build
cd sdk/resourcemanager/cosmos/armcosmos
go clean ./...
go build ./...

# Vet
go vet ./...

# Test
go test -v -coverprofile coverage.txt ./...

# Format check
gofmt -l .

# Mod check
go mod tidy
git diff go.mod go.sum

# If golangci-lint is installed
golangci-lint run -c ../../eng/.golangci.yml
```

### Understanding Test Proxy
The test proxy records and plays back HTTP interactions:

**Setup:**
- Test recordings stored in Azure SDK assets repo
- Tag: `go/resourcemanager/cosmos/armcosmos_6b5b7eed9c`
- Mode: Playback (default for CI)

**Issues:**
- Missing recordings → Re-record in live mode
- Outdated recordings → Update recordings
- Proxy not starting → Check port 27301 availability

## Prevention Best Practices

### Before Committing
Run this checklist:
```bash
cd sdk/resourcemanager/cosmos/armcosmos

# Clean build
go clean ./...
go build ./...

# Tests
go test ./...

# Format
gofmt -w .

# Tidy
go mod tidy

# Vet
go vet ./...
```

### Pre-Push Validation
Create a git pre-push hook:
```bash
#!/bin/bash
cd sdk/resourcemanager/cosmos/armcosmos
go build ./... && go test ./... && go vet ./... && [ -z "$(gofmt -l .)" ]
```

### IDE Setup
Configure your IDE for:
- Automatic `gofmt` on save
- Go import organization
- Linting on save
- Inline error checking

## Getting Help

### Resources
- **Pipeline Template**: `/eng/pipelines/templates/jobs/archetype-sdk-client.yml`
- **Build Scripts**: `/eng/scripts/`
- **Linting Config**: `/eng/.golangci.yml`
- **Test Utilities**: `/eng/tools/`

### Contact
- **Go SDK Team**: Use "Language - Go" Teams channel under "Azure SDK" team
- **Code Owners**: Check `.github/CODEOWNERS` for module owners
- **Issues**: Open issue with "Cosmos DB" label on GitHub

## Pipeline-Specific Information

### armcosmos Pipeline Details
- **Pipeline ID**: Build 5670015 (example from issue)
- **Typical Duration**: 10-15 minutes
- **Stages**: Build → Analyze → (Conditional: Live Tests, Release)
- **Platforms**: Linux and Windows
- **Go Version**: 1.23.2

### Key Pipeline Parameters
- `ServiceDirectory`: `resourcemanager/cosmos/armcosmos`
- `UsePipelineProxy`: `false`
- `TestRunTime`: `600s`
- `EnableRaceDetector`: `false`

## Quick Fixes

### Fix All Common Issues
```bash
cd sdk/resourcemanager/cosmos/armcosmos

# Format code
gofmt -w .

# Organize imports
goimports -w .

# Tidy dependencies
go mod tidy

# Verify everything works
go build ./... && go test ./... && go vet ./...
```

### Generate Missing Files
If doc.go is missing:
```bash
cat > doc.go << 'EOF'
// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License. See License.txt in the project root for license information.

// Package armcosmos provides operations for working with Azure Cosmos DB.
package armcosmos
EOF
```

## Monitoring and Maintenance

### Regular Checks
- Weekly: Review dependency updates
- Monthly: Check for deprecated functions
- Per PR: Run full validation suite
- Before release: Complete pipeline validation

### Performance Monitoring
- Test execution time
- Build duration
- Coverage trends
- Linting issue trends

---

**Last Updated**: 2025-12-18
**Module**: armcosmos v3.4.0
**Go Version**: 1.23.2
